<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <script src="https://aframe.io/releases/0.3.0/aframe.js"></script>
    <script src="lib/altspace.min.js"></script>
    <script src="lib/AudioSampleLoader.js"></script>
    <script src="lib/jquery-3.2.1.min.js"></script>
    <title>BeatLab!</title>
</head>
<body>

<script src="script/altspacepoly.js"></script>
<script src="script/scheduler.js"></script>
<script src="script/soundsettings.js"></script>
<script src="script/score.js"></script>
<script src="script/markers.js"></script>
<script src="script/utils.js"></script>
<script src="script/eventhandler.js"></script>
<script src="script/main.js"></script>

<!--<a-scene altspace="vertical-align:bottom" keyboard-shortcuts sync-system>-->
<a-scene altspace="fullspace: true" keyboard-shortcuts sync-system>
    <a-entity position="0 0 1.5" camera="userHeight: 1.6" look-controls wasd-controls>
        <a-cursor color="#2E3A87"></a-cursor>
    </a-entity>

    <a-assets>
        <img id="studded-texture" src="img/studded.jpg">
        <img id="noise-texture" src="img/noise.png">
        <img id="copper-texture" src="img/copper.jpg">
        <img id="galv-texture" src="img/galvanised.jpg">
        <img id="green-texture" src="img/green.jpg">
        <img id="tongue-texture" src="img/tongue.jpg">
        <img id="stain-texture" src="img/stain.jpg">
        <img id="rock-texture" src="img/rock.jpg">
        <img id="cloud-texture" src="img/cloud.jpg">
        <img id="play-texture" src="img/play.png">
        <img id="cable-texture" src="img/cable_stripe.png">
        <img id="up-arrow" src="img/up_arrow.png">
        <img id="down-arrow" src="img/down_arrow.png">
        <img id="volume-control" src="img/volume_control.png">
        <img id="mute" src="img/mute.png">
        <img id="unmute" src="img/unmute.png">
        <img id="plus" src="img/plus.png">
        <img id="minus" src="img/minus.png">
    </a-assets>

    <a-entity position="0.6 -0.15 -1" rotation="-30 0 0">
        <a-circle volume-control="down"
                  transparent="true"
                  altspace-cursor-collider
                  n-sphere-collider
                  material="src:#minus;"
                  position="0.126 0 0"
                  scale="0.04 0.04 0.04"
                  rotation="0 0 0"
                  n-cockpit-parent>
        </a-circle>

        <a-circle volume-control="up"
                  transparent="true"
                  altspace-cursor-collider
                  n-sphere-collider
                  material="src:#plus;"
                  scale="0.04 0.04 0.04"
                  rotation="0 0 0"
                  n-cockpit-parent>
        </a-circle>

        <a-circle mute
                  transparent="true"
                  altspace-cursor-collider
                  n-sphere-collider
                  material="src:#mute;"
                  position="0.252 0 0"
                  scale="0.04 0.04 0.04"
                  rotation="0 0 0"
                  n-cockpit-parent>
        </a-circle>
    </a-entity>

    <a-entity id="root" position="3.5 0 -7">
        <!--<a-entity id="root">-->

        <a-circle onclick="toggleTest()" altspace-cursor-collider color="#000" position="0 3 0" side="double" scale="0.5 0.5 0.5">

            <a-entity position="0 0 0.1">
                <a-entity n-text="fontSize:1pt;width:1.8;height:0.1;text:SHOULD lag- setInterval:" position="0 0.6 0"></a-entity>
                <a-entity id="intervalCount" n-text="fontSize:1pt;width:1;height:0.1;text:0" position="0 0.45 0"></a-entity>
                <a-entity n-text="fontSize:1pt;width:1.8;height:0.1;text:NEVER lag - requestAnimationFrame seconds since the app started:" position="0 0.2 0"></a-entity>
                <a-entity id="rafCount" n-text="fontSize:1pt;width:3;height:0.1;text:0" position="0 -0.05 0"></a-entity>
                <a-entity n-text="fontSize:1pt;width:1.8;height:0.1;text:Beeps are 1 second long. Count (from 0) to tell if the timers above are out" position="0 -0.35 0"></a-entity>
            </a-entity>
        </a-circle>

        <a-cylinder material="src:#galv-texture;" height="0.9" position="0 0.5 0" color="#556" radius="0.3">
            <a-sphere id="beater" playable position="0 0.3 0.3" radius="0.1" material="src:#play-texture" rotation="0 -90 30" color="#ddd"></a-sphere>
        </a-cylinder>

        <a-cylinder timer altspace-cursor-collider id="clock-face" material="src:#studded-texture;repeat: 10 1" segments-radial="16" height="0.05" rotation="0 90 40" position="0 1.3 0" radius="0.405" n-mesh-collider="convex:false">
            <a-ring ring="beep" radius-outer="0.380" radius-inner="0.378" rotation="-90 0 0" position="0 0.03 0"></a-ring>
            <a-ring ring="bork" radius-outer="0.330" radius-inner="0.328" rotation="-90 0 0" position="0 0.03 0"></a-ring>
            <a-ring ring="snare" radius-outer="0.280" radius-inner="0.278" rotation="-90 0 0" position="0 0.03 0"></a-ring>
            <a-ring ring="hat" radius-outer="0.230" radius-inner="0.228" rotation="-90 0 0" position="0 0.03 0"></a-ring>
            <a-ring ring="kick" radius-outer="0.180" radius-inner="0.178" rotation="-90 0 0" position="0 0.03 0"></a-ring>

            <a-circle material="src:#noise-texture; repeat:5 5" rotation="90 0 0" position="0 0.028 0.005" geometry="radius: 0.405" side="double" theta-length="4" color="#f0eae0" animate-theta></a-circle>

            <a-circle radius="0.3" scale="0.5 0.5 0.5" material="src:#noise-texture; repeat:5 5" color="#181818" position="0 0.03 0" rotation="-90 0 0">
                <a-circle altspace-cursor-collider bpm-change="up" radius="0.08" rotation="0 0 -90" material="src:#up-arrow" position="0.15 0 0.01"></a-circle>

                <a-entity bpm-label position="0 0 0.01" rotation="0 0 -90" n-text="fontSize:1pt;width:0.5;height:0.1"></a-entity>

                <a-circle altspace-cursor-collider bpm-change="down" radius="0.08" rotation="0 0 -90" material="src:#down-arrow" position="-0.15 0 0.01"></a-circle>
            </a-circle>
        </a-cylinder>

        <a-sphere instrument="kick" material="src:#noise-texture; repeat:5 5" color="#6688ff" position="1 1 1.5" radius="0.3">
        </a-sphere>

        <a-box instrument="hat" depth="0.5" height="0.5" width="0.5"
               material="src:#copper-texture;color: #ff6688" position="-1 1 1.5">
        </a-box>

        <a-tetrahedron instrument="snare" rotation="215 45 45" radius="0.6"
                       material="src:#green-texture;color:#b0d8b0" position="-1.7 1 -0.8">
        </a-tetrahedron>

        <a-cylinder height="1" radius="0.08" position="0 1.2 -1.5" material="src:#stain-texture"></a-cylinder>
        <a-sphere instrument="bork" material="src:#tongue-texture;color:#aaf"
                  position="0 1 -1.5" radius="0.15">
        </a-sphere>

        <a-cone instrument="beep" height="0.7" radius-top="0.2" radius-bottom="0.38" open-ended="true" color="#ffc34e"
                material="src:#rock-texture;side:double" position="1.7 1.1 -0.8">

            <a-torus radius="0.15" rotation="90 0 0" radius-tubular="0.029" position="0 0.2 0" material="src:#cloud-texture;color:#ffe8c0;">
                <a-animation attribute="position" from="0 0.2 0" to="0 2 0" begin="playtime" dur="500" fill="none" easing="linear"></a-animation>
            </a-torus>
        </a-cone>
    </a-entity>
</a-scene>


<script>

    var intervalfunction;
    var isRunning = false;

    var audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    var source = audioCtx.createBufferSource();
    var loader = new AudioSampleLoader();
    loader.src = "audio/sec.wav";
    loader.ctx = audioCtx;
    loader.onload = function () {
        source.buffer = loader.response;
        source.connect(audioCtx.destination);
        source.loop = true;
    };
    loader.send();

    function runTest() {
        isRunning = true;
        var intervalCountDiv = document.querySelector("#intervalCount");
        var rafCountDiv = document.querySelector("#rafCount");
        var intervalCount = 0.000;
        var rafCount = 0.000;

        var startTime = new Date().getTime();

        intervalfunction = setInterval(function () {
            intervalCount += 0.25;
            intervalCountDiv.setAttribute("n-text", "text", Math.floor(intervalCount));
        }, 250);

        var timingFunction = function () {
            rafCount = (new Date().getTime() - startTime) / 1000;
            rafCountDiv.setAttribute("n-text", "text", Math.floor(rafCount));
            if (isRunning) {
                window.requestAnimationFrame(timingFunction);
            }
        };

        source.start();

        timingFunction();
    }

    function stopTest() {
        isRunning = false;
        clearInterval(intervalfunction);
        source.stop();
    }

    function toggleTest() {
        if (isRunning) {
            stopTest();
        } else {
            runTest();
        }
    }
</script>


</body>
</html>
